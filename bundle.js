(()=>{"use strict";(()=>{const e=(e,t,o)=>{e.addEventListener("load",(()=>{let r;switch(e.status){case 200:t(e.response);break;case 400:r="Неверный запрос";break;case 401:r="Пользователь не авторизован";break;case 404:r="Ничего не найдено";break;default:r="Cтатус ответа: : "+e.status+" "+e.statusText}r&&o(r)})),e.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+e.timeout+"мс")})),e.timeout=1e4};window.load={loadData:(t,o)=>{const r=new XMLHttpRequest;r.responseType="json",e(r,t,o),r.open("GET","https://21.javascript.pages.academy/keksobooking/data"),r.send()},uploadData:(t,o,r)=>{const n=new XMLHttpRequest;n.responseType="json",e(n,o,r),n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(t)}}})(),window.util={setDisability:(e,t)=>{e.forEach((e=>{e.disabled=t}))},getRandomNumBetween:(e,t)=>Math.round(Math.random()*(t-e)+e),fillFragment:(e,t,o)=>{for(let r=0;r<t.length;r++)e.appendChild(o(t[r]));return e},includesAll:(e,t)=>t.every((t=>e.includes(t))),debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}}},(()=>{const e=document.querySelector(".map").querySelector(".map__pin--main"),t={X:e.style.left,Y:e.style.top},o=e=>{0===e.button&&window.main.activatePage()},r=e=>{"Enter"===e.key&&window.main.activatePage()};e.addEventListener("mousedown",o),e.addEventListener("keydown",r),e.addEventListener("mousedown",(e=>{0===e.button&&window.move.movePin(e)})),window.map={setMainPinStartCoords:()=>{e.style.left=t.X,e.style.top=t.Y},onPinMouseDown:o,onPinKeyDown:r}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".ad-form"),o=t.querySelector("#type"),r=t.querySelector("#price"),n=t.querySelector("#timein"),a=t.querySelector("#timeout"),d=t.querySelector("#room_number"),i=t.querySelector("#capacity").querySelectorAll("option"),s={1:[1],2:[1,2],3:[1,2,3],100:[0]},c={bungalow:0,flat:1e3,house:5e3,palace:1e4},l=e=>{const t=c[e.value];r.minLength=t,r.placeholder=t},u=e=>{var t;"timein"===(t=e.target).name?a.value=t.value:n.value=t.value},m=e=>{const t=s[e.value];window.util.setDisability(i,!0),t.forEach((e=>{i.forEach((t=>{parseInt(t.value,10)===e&&(t.selected=!0,t.disabled=!1)}))}))};o.addEventListener("change",(e=>{l(e.target)})),n.addEventListener("change",u),a.addEventListener("change",u),d.addEventListener("change",(e=>{m(e.target)})),window.form={fillAddressInput:o=>{t.querySelector("input[name=address]").value=o?`${parseInt(e.style.left,10)+Math.floor(32.5)}, ${parseInt(e.style.top,10)+84}`:`${parseInt(e.style.left,10)+Math.floor(32.5)}, ${parseInt(e.style.top,10)+32.5}`},checkTypePrice:l,checkRoomCapacity:m,onSubmit:e=>{e.preventDefault(),window.load.uploadData(new FormData(t),window.main.successHandler,window.main.errorHandler)},formReset:()=>{t.reset(),window.main.deactivatePage(),e.addEventListener("mousedown",window.map.onPinMouseDown),e.addEventListener("keydown",window.map.onPinKeyDown)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector(".ad-form-header__input"),o=e.querySelector(".ad-form-header__preview img"),r=e.querySelector(".ad-form__photo-container"),n=e.querySelector(".ad-form__input"),a=e.querySelector(".ad-form__photo"),d=document.createDocumentFragment(),i=["jpg","jpeg","png"];t.addEventListener("change",(()=>{const e=t.files[0],r=e.name.toLowerCase();if(i.some((e=>r.endsWith(e)))){const t=new FileReader;t.addEventListener("load",(()=>{o.src=t.result})),t.readAsDataURL(e)}})),n.addEventListener("change",(()=>{const e=Array.from(n.files),t=[];e.forEach((e=>t.push(e.name.toLowerCase()))),t.every((e=>i.some((t=>e.endsWith(t)))))&&(a.remove(),e.forEach((e=>{const t=new FileReader;let o=a.cloneNode(!0);t.addEventListener("load",(()=>{o.innerHTML=`<img src='${t.result}' width='40' height='44' alt='Фотография жилья'>`})),t.readAsDataURL(e),d.appendChild(o)})),r.appendChild(d))}))})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o=t.clientWidth,r=t.clientHeight+19,n=e.clientWidth;window.move={movePin:e=>{let a={x:e.clientX,y:e.clientY};const d=e=>{e.preventDefault(),window.form.fillAddressInput(!0);let d=t.offsetLeft,i=t.offsetTop;const s=a.x-e.clientX,c=a.y-e.clientY;a={x:e.clientX,y:e.clientY},d<0-o/2?d=0-o/2:d>n-o/2&&(d=n-o/2),i<130-r?i=130-r:i>630-r&&(i=630-r),t.style.left=d-s+"px",t.style.top=i-c+"px"},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",i)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={createAd:t=>{const o=e.cloneNode(!0),r=o.querySelector("img");return o.style=`left: ${t.location.x-25}px; top: ${t.location.y-70}px;`,r.src=""+t.author.avatar,r.alt=""+t.offer.title,o.addEventListener("click",(()=>{window.card.renderCard(t)})),o},removePin:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters-container"),o=document.querySelector("#card").content.querySelector(".map__card"),r={palace:"Дворец",house:"Дом",bungalow:"Бунгало",flat:"Квартира"};window.card={createCard:e=>{const t=1===e.offer.rooms?e.offer.rooms+" комната для ":e.offer.rooms+" комнаты для ",n=1===e.offer.guests?e.offer.guests+" гостя":e.offer.guests+" гостей",a=o.cloneNode(!0);a.querySelector(".popup__avatar").src=""+e.author.avatar,a.querySelector(".popup__avatar").alt=""+e.offer.title,a.querySelector(".popup__title").textContent=""+e.offer.title,a.querySelector(".popup__text--address").textContent=""+e.offer.address,a.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",a.querySelector(".popup__type").textContent=""+r[e.offer.type],a.querySelector(".popup__text--capacity").textContent=t+n,a.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,a.querySelector(".popup__description").textContent=""+e.offer.description,((e,t)=>{const o=t.querySelector(".popup__features");if(e.offer.features.length){o.innerHTML="";for(let t=0;t<e.offer.features.length;t++){let r=document.createElement("li");r.classList.add("popup__feature","popup__feature--"+e.offer.features[t]),o.appendChild(r)}}else o.remove()})(e,a),((e,t)=>{const o=t.querySelector(".popup__photos"),r=o.querySelector(".popup__photo");if(e.offer.photos.length){r.src=""+e.offer.photos[0];for(let t=1;t<e.offer.photos.length;t++){let n=r.cloneNode();n.src=""+e.offer.photos[t],o.appendChild(n)}}else o.remove()})(e,a);const d=a.querySelector(".popup__close"),i=e=>{"Escape"===e.key&&(a.remove(),document.removeEventListener("keydown",i))};return d.addEventListener("click",(()=>{a.remove()})),document.addEventListener("keydown",i),a},renderCard:o=>{const r=e.querySelector(".map__card");r&&r.remove(),e.insertBefore(window.card.createCard(o),t)},removeCard:()=>{const t=e.querySelector(".map__card");t&&t.remove()}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),a=e.querySelector("#housing-features");window.filter={applyAllFilters:e=>e.filter((e=>(e=>"any"===t.value||e.offer.type===t.value)(e)&&(e=>{let t;switch(!0){case e.offer.price<1e4:t="low";break;case e.offer.price>5e4:t="high";break;default:t="middle"}return"any"===o.value||t===o.value})(e)&&(e=>"any"===r.value||e.offer.rooms===parseInt(r.value,10))(e)&&(e=>"any"===n.value||e.offer.guests===parseInt(n.value,10))(e)&&(e=>{let t=a.querySelectorAll(".map__checkbox:checked"),o=[];return t.forEach((e=>{o.push(e.value)})),window.util.includesAll(e.offer.features,o)})(e))).slice(0,5)}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=e.querySelector(".map__filters"),r=document.createDocumentFragment();let n=[];const a=e=>{window.pin.removePin();const o=window.filter.applyAllFilters(e);window.util.fillFragment(r,o,window.pin.createAd),t.appendChild(r)};o.addEventListener("change",window.util.debounce((()=>{window.card.removeCard(),a(n)}))),window.render={successHandler:e=>{n=e,a(n)},errorHandler:t=>{let o=document.createElement("div");o.style="z-index: 100; width: 100%; margin: 0 auto; padding: 20px; text-align: center; background-color: rgba(255, 86, 53, 0.7); color: white",o.style.position="absolute",o.style.bottom=0,o.style.fontSize="30px",o.textContent=t,e.insertAdjacentElement("beforeend",o)}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector(".map"),o=t.querySelector(".map__pin--main"),r=document.querySelectorAll(".map__filter"),n=document.querySelector(".ad-form"),a=n.querySelectorAll(".ad-form__element"),d=n.querySelector("#type"),i=n.querySelector("#room_number"),s=n.querySelector(".ad-form__reset"),c=document.querySelector("#success").content.querySelector(".success"),l=document.querySelector("#error").content.querySelector(".error"),u=(e,o)=>{e?(t.classList.remove("map--faded"),n.classList.remove("ad-form--disabled")):(t.classList.add("map--faded"),n.classList.add("ad-form--disabled")),window.util.setDisability(a,o),window.util.setDisability(r,o)},m=()=>{u(!1,!0),window.pin.removePin(),window.map.setMainPinStartCoords(),window.form.fillAddressInput(!1),n.removeEventListener("submit",window.form.onSubmit),s.removeEventListener("click",window.form.formReset)},p=e=>{"Escape"===e.key&&c.remove(),document.removeEventListener("keydown",p)},f=e=>{"Escape"===e.key&&l.remove(),document.removeEventListener("keydown",f)};m(),window.main={deactivatePage:m,activatePage:()=>{u(!0,!1),window.load.loadData(window.render.successHandler,window.render.errorHandler),window.form.fillAddressInput(!0),window.form.checkTypePrice(d),window.form.checkRoomCapacity(i),o.removeEventListener("mousedown",window.map.onPinMouseDown),o.removeEventListener("keydown",window.map.onPinKeyDown),n.addEventListener("submit",window.form.onSubmit),s.addEventListener("click",window.form.formReset)},successHandler:()=>{window.form.formReset(),window.main.messageHandler(c,p)},errorHandler:()=>{window.main.messageHandler(l,f)},messageHandler:(t,o)=>{e.appendChild(t),t.addEventListener("click",(()=>{t.remove(),document.removeEventListener("keydown",o)})),document.addEventListener("keydown",o)}}})()})();